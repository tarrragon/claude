# 🚀 Hook 系統方法論

## 📖 概述

本專案採用完全自動化的 Hook 系統來執行 CLAUDE.md 中定義的所有開發規範。每個 hook 都有明確的觸發條件、執行邏輯和強制執行機制，確保開發品質和流程合規性。

## 🏗️ 系統架構

### Hook 執行時機圖

```text
User Input → UserPromptSubmit → PreToolUse → Tool Execution → PostToolUse → Stop
     ↓              ↓               ↓                ↓              ↓        ↓
  工作流程檢查    阻止狀態檢查    效能監控開始      效能監控結束     版本檢查
  任務逃避偵測    安全檢查       錯誤攔截        品質檢查
                                             程式異味偵測
                                             文件更新提醒
```

### 三大鐵律自動執行

1. **測試通過率鐵律** → UserPromptSubmit Hook + PreToolUse Hook
2. **永不放棄鐵律** → Task Avoidance Detection Hook + Block Check Hook
3. **架構債務零容忍鐵律** → Architecture Debt Detection Hook + Code Smell Detection Hook + PostToolUse Hook

## 📋 Hook 清單與方法論

### 🔄 SessionStart Hook

**檔案**: `scripts/startup-check-hook.sh`

**觸發時機**: Claude Code session 啟動時

**方法論**:
- **原則**: 確保每個開發 session 都在已知良好的狀態下開始
- **檢查範圍**: Git 狀態、專案檔案、開發環境、版本一致性
- **失敗處理**: 提供明確的修復指引，但不阻止 session 啟動

**關鍵決策邏輯**:
1. Git 同步狀態 → 遠端領先時提示同步
2. 檔案載入確認 → 缺失檔案時警告
3. 開發環境檢查 → 依賴問題時建議重新安裝
4. 工作日誌狀態 → 提供下一步開發建議

---

### 💬 UserPromptSubmit Hook

**檔案**: `scripts/prompt-submit-hook.sh` + `scripts/task-avoidance-detection-hook.sh`

**觸發時機**: 用戶提交每個 prompt 時

**方法論**:
- **原則**: 在問題發生前攔截，而非事後修復
- **檢查範圍**: ESLint 錯誤、技術債務累積、任務逃避行為
- **強制性**: 發現關鍵問題時記錄追蹤，逃避行為時完全阻止

**任務逃避偵測算法**:
```bash
# 1. 禁用詞彙掃描
for 詞彙 in 工作日誌, Git提交, TodoList:
    if 包含("太複雜", "暫時", "跳過", ...):
        標記逃避行為

# 2. 行為模式檢查
if 跳過測試數量 > 0 OR ESLint忽略 > 5 OR 技術債務 > 15:
    標記逃避行為

# 3. 完整性檢查
if 程式碼變更 > 0 AND 測試變更 == 0:
    標記逃避行為
```

**阻止機制**: 建立 `$CLAUDE_PROJECT_DIR/.claude/TASK_AVOIDANCE_BLOCK` 檔案，觸發所有後續操作阻止

---

### 🛡️ PreToolUse Hook

**檔案**: `scripts/task-avoidance-block-check.sh` + 工具特定檢查

**觸發時機**: 任何工具使用前

**方法論**:
- **原則**: 防禦性檢查，確保操作在安全狀態下執行
- **檢查順序**: 阻止狀態 → 工具特定安全檢查 → 允許執行
- **零容忍**: 任何阻止狀態都完全禁止操作

**阻止狀態檢查流程**:
1. 檢查 `$CLAUDE_PROJECT_DIR/.claude/TASK_AVOIDANCE_BLOCK` 檔案存在性
2. 如果存在 → 顯示詳細修復指引並退出(exit 1)
3. 如果不存在 → 繼續執行

---

### ✏️ PostToolUse Hook

**檔案**: 複合 hook 執行鏈

**觸發時機**: 檔案編輯或測試執行後

**方法論**:
- **原則**: 即時品質檢查和問題追蹤，確保變更不降低程式碼品質
- **執行順序**: 效能監控開始 → 基礎檢查 → 程式異味偵測 → 文件更新提醒 → 效能監控結束
- **非阻塞**: 檢查發現問題時記錄和追蹤，但不阻止開發流程

#### 程式異味偵測方法論

**演算法策略**:
```bash
# 複雜度偵測
函數長度 > 30行 → 長函數異味
巢狀層級 > 4層 → 深層巢狀異味
參數數量 > 5個 → 過長參數列表異味

# 維護性偵測
重複程式碼塊 > 5處 → 程式碼重複異味
魔術數字 > 3處 → 魔術數字異味
類別行數 > 200行 → 大型類別異味

# 架構偵測
依賴數量 > 10個 → 高耦合異味
方法數量 > 10個 → 神秘類別異味
```

**Agent 整合策略**:
1. 偵測到異味 → 生成結構化報告
2. 建立 Agent 任務檔案 (JSON 格式)
3. 啟動背景 Agent 處理 TodoList 更新
4. 主流程繼續，不中斷開發

---

### 🛑 Stop Hook

**檔案**: `scripts/stop-hook.sh`

**觸發時機**: Claude 主要代理完成回應時

**方法論**:
- **原則**: 智能版本推進建議，基於工作完成狀態和目標達成情況
- **分析範圍**: 檔案變更量、工作日誌狀態、TodoList 完成度
- **建議導向**: 提供明確的下一步行動建議，不強制執行

**版本推進決策邏輯**:
```bash
if 檔案變更 > 0:
    if 工作日誌標記完成:
        if TodoList系列完成:
            建議中版本推進
        else:
            建議小版本推進
    else:
        建議繼續開發
```

---

### ⚡ Performance Monitor Hook

**檔案**: `scripts/performance-monitor-hook.sh`

**觸發時機**: 其他 hook 執行前後

**方法論**:
- **原則**: 持續效能監控，預防 hook 系統本身成為開發瓶頸
- **監控指標**: 執行時間、記憶體使用、執行頻率
- **優化導向**: 自動生成效能優化建議

**效能閾值設計**:
- 理想: < 1秒 (正常運作)
- 警告: 2-5秒 (建議優化)
- 錯誤: > 5秒 (需要立即優化)

**優化策略自動建議**:
1. 檔案掃描優化 → 限制搜尋深度和範圍
2. 快取機制 → 避免重複計算
3. 平行處理 → 獨立檢查項目並行執行
4. 條件執行 → 大量變更才執行完整檢查

---

### 📚 Auto-Documentation Update Hook

**檔案**: `scripts/auto-documentation-update-hook.sh`

**觸發時機**: 程式碼檔案變更後

**方法論**:
- **原則**: 主動文件同步提醒，確保文件與程式碼同步更新
- **智能分析**: 根據變更檔案類型自動判斷需要更新的文件
- **優先級分級**: High/Medium/Low 優先級，指導更新順序

**變更類型對應**:
- API 變更 → `docs/api/` (High)
- 架構變更 → `docs/domains/architecture/` (Medium)
- 配置變更 → `README.md` (High)
- 新功能 → `CHANGELOG.md` (Medium)
- 測試變更 → `docs/testing/` (Low)

## 🔧 Hook 系統設計原則

### 1. **分離關注點**
- 每個 hook 專注於特定的檢查範圍
- 避免單一 hook 承擔過多責任
- 清晰的輸入輸出介面

### 2. **非阻塞優先**
- 大部分檢查採用記錄和追蹤方式
- 只有關鍵違規才阻止操作
- 保持開發流程的流暢性

### 3. **漸進式強制**
- 警告 → 記錄 → 追蹤 → 阻止
- 給予開發者理解和修正的機會
- 關鍵問題採用零容忍態度

### 4. **智能化決策**
- 基於歷史資料和趨勢分析
- 上下文感知的檢查邏輯
- 自動優化和調整建議

### 5. **可觀測性**
- 詳細的日誌記錄
- 效能指標追蹤
- 問題追蹤和報告生成

## 📊 成效量化

### 自動化覆蓋率
- 環境檢查: 100%
- 品質控制: 100%
- 問題追蹤: 100%
- 永不放棄鐵律: 100%
- 程式異味偵測: 95%
- 效能監控: 100%
- 文件同步: 90%

### 品質保證機制
- ESLint 錯誤: 自動偵測和追蹤
- 測試覆蓋: 強制檢查
- 技術債務: 自動監控和限制
- 架構債務: 智能偵測和阻止

## 🔄 維護和擴展

### Hook 新增流程
1. 識別新的品質控制需求
2. 設計檢查邏輯和閾值
3. 實作 hook 腳本
4. 更新 `$CLAUDE_PROJECT_DIR/.claude/settings.local.json`
5. 建立說明文件
6. 測試和驗證

### 效能優化流程
1. Performance Monitor Hook 自動偵測
2. 分析效能瓶頸根因
3. 實施優化策略
4. 驗證改善效果
5. 更新效能基準

這個 Hook 系統是專案品質保證的核心基礎設施，確保每個開發決策都符合專案的高品質標準。
