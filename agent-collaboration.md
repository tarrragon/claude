# 🤖 Agent 協作規範

根據 Claude Code sub-agent 最佳實踐和**敏捷重構方法論**，本專案採用**主線程分派、代理人執行**的協作模式。主線程負責任務統籌和分派，專業代理人負責執行具體的開發、測試、重構工作。

## 🚨 v0.10.x階段特別協作要求

### 📋 問題發現機制強制傳達 (2025-09-29更新)

**⚠️ 所有代理人必須理解並傳達給後續任務執行者**：

**核心原則**: **v0.10.x前期的所有測試是為了找出現在既有的問題，提供給後面的任務排程修復。發現問題後不急於修復，而是要系統性記錄和規劃後續修復策略。**

#### 🔍 問題發現優先於修復的工作模式
- **發現問題時**：記錄 → 分析 → 歸類 → 對應版本規劃 → 制定修復策略
- **絕不立即修復**：避免症狀性修復，要理解問題背後的系統性原因
- **系統性思考**：unused imports可能代表整個功能模組的實作缺失
- **版本對應**：每個發現的問題都要對應到v0.10.x的具體修復階段

#### 📊 v0.10.2檢測驗證成果 (重要背景資訊)
- **技術債務低於預期**：從聲稱672個問題實際縮減至95個 (86%改善)
- **問題分類準確**：68%搜尋功能缺失、26%書庫展示缺失、6%ISBN掃描缺失
- **版本規劃驗證**：實際問題分佈與既定v0.10.x階段規劃高度吻合
- **只有2個CRITICAL問題**：DatabaseService.clearAllData方法缺失、Flutter測試框架環境問題

#### 🤖 代理人任務分派要求
**所有代理人在接收任務時都必須**：
1. **確認理解問題發現機制**：先發現記錄，不急於修復
2. **識別問題背後的系統性原因**：單一問題對應的功能模組缺失
3. **對應版本規劃**：將發現問題對應到正確的v0.10.x修復階段
4. **記錄到Memory系統**：重要發現必須建立Memory記錄供後續參考

### 📝 Memory Network Builder 特殊要求
**在v0.10.x階段，memory-network-builder必須特別關注**：
- **問題發現模式記錄**：每次檢測發現的問題分類和對應版本
- **架構債務識別**：unused imports背後的功能實作缺口分析
- **修復策略連結**：建立問題發現與修復策略的知識連結
- **方法論驗證**：記錄問題發現機制的實戰效果和改進建議

**Memory建立要求**：
- 標題必須結論導向：如「v0.10.2檢測發現技術債務低於預期86%」
- 內容包含具體數據：問題數量、分類比例、對應版本
- 建立明確連結：與v0.10.x階段規劃和修復策略的連結關係

## 📋 核心設計原則

**敏捷重構協作模式**:

- **任務原子化**：每個任務控制在1-2小時內完成，影響檔案數≤5個
- **專業分工執行**：代理人具備完整的工具權限，直接執行分派的開發任務
- **品質門檻強制**：所有任務完成必須通過測試檢查，100%通過率是最低要求
- **主線程統籌**：主線程只負責任務分派、進度監控、跨代理人協調

**工作流程模式**:

1. **主線程依照工作日誌分派任務給專業代理人**
2. **代理人直接執行開發、測試、重構工作**
3. **代理人更新工作日誌，記錄執行過程和結果**
4. **主線程監控進度，處理升級請求和任務重新分派**
5. **重構代理人驗證程式碼品質，批准任務完成**

**工作流程控管**
無論是從主線程交接給Sub-agent或者從Sub-agent交付回主線程，都要做commit，不應該累積還沒commit的程式或者文件就把任務交付出去

## 🎯 Sub-agent 角色定位

### 🧠 知識管理層級 (新增知識捕獲層)

- **memory-network-builder** (🧠): 記憶網路架構師
  - 負責知識原子化捕獲、洞察連結建立、決策記錄管理
  - **觸發時機**: 每個TDD Phase完成後 + 專家審查發現重要洞察時
  - **核心職責**: 將洞察轉化為可連結的記憶單元、建立知識圖譜

### 🔍 專家審查層級 (品質把關層)

- **linux** (🔨): Linus Torvalds 程式碼品質專家
  - 負責設計合理性審查、複雜度評估、"Good Taste"品質把關
  - **觸發時機**: Phase 1設計完成後 + Phase 4重構完成後
  - **核心職責**: 拒絕過度設計、消除特殊情況、確保實用主義
  - **知識協作**: 與memory-network-builder協作記錄"Good Taste"設計模式

- **john-carmack** (⚡): John Carmack 效能系統架構師
  - 負責架構效能審查、熱路徑優化、確定性設計評估
  - **觸發時機**: Phase 2測試完成後 + Phase 3實作完成後
  - **核心職責**: 熱路徑識別、控制流程簡化、狀態管理純度
  - **知識協作**: 與memory-network-builder協作記錄效能優化洞察和架構模式

### 🔄 TDD協作流程導向層級

- **lavender-interface-designer** (🎨): 功能設計師專家 - 對應TDD Phase 1
  - 負責功能規劃和需求分析，建立清楚的功能需求和設計規範
  - **錯誤修復專業職責**: 依據「錯誤修復和重構方法論」，負責複雜問題分析和設計缺陷修正
  - 建立工作日誌：`docs/work-logs/vX.X.X-feature-design.md`
  - 交接標準：功能需求清楚、API介面定義完整、驗收標準明確

- **sage-test-architect** (🧪): 測試工程師專家 - 對應TDD Phase 2
  - 根據功能設計，設計並實作完整的測試案例
  - 更新工作日誌：新增測試設計章節到既有工作日誌
  - 交接標準：測試案例實作為程式碼、測試覆蓋率達標、測試程式碼品質良好

- **pepper-test-implementer** (💻): TDD實作規劃師專家 - 對應TDD Phase 3
  - 負責實作策略規劃、權宜方案識別、技術債務記錄，提供詳細實作指引
  - 更新工作日誌：新增實作記錄章節到既有工作日誌
  - 交接標準：實作策略完整規劃、程式碼範例提供、開發過程設計完整記錄

- **cinnamon-refactor-owl** (🏗️): 重構設計師專家 - 對應TDD Phase 4
  - 執行「🧠 TDD 驅動重構方法論」完整流程，改善程式碼品質和架構
  - **錯誤修復專業職責**: 依據「錯誤修復和重構方法論」，負責測試修改檢視和架構調整規劃
  - 建立重構工作日誌：按照重構方法論要求建立獨立工作日誌
  - 交接標準：重構方法論完整執行、技術債務已解決、重構經驗記錄完整

### 🚨 PM 決策強制檢查清單（Phase 3 完成後）

**觸發時機**: pepper-test-implementer 完成 Phase 3 實作規劃，準備進入 Phase 4

**強制性原則**: **Phase 4 是 TDD 四階段的強制組成部分，不可基於任何理由跳過或簡化**

#### ✅ 強制性問題（必須全部回答「是」）

- [ ] **Phase 1-3 是否已完成？** - 確認四階段流程進度
- [ ] **是否要立即分派 cinnamon-refactor-owl？** - 強制進入 Phase 4
- [ ] **是否禁止建議「跳過」或「輕量級檢查」？** - 避免逃避行為
- [ ] **是否理解 Phase 4 是強制性的，與程式碼品質無關？** - 原則確認

#### ❌ 禁止的思考模式（PM 不可使用）

- ❌ "程式碼看起來已經很好，可以跳過 Phase 4"
- ❌ "只需要輕量級檢查就好，不用完整重構評估"
- ❌ "Phase 4 可以簡化執行，快速檢查一下"
- ❌ "讓我先評估是否真的需要 Phase 4"
- ❌ "測試都通過了，程式碼品質 A+，應該不需要重構"

#### ✅ 正確的思考模式（PM 必須遵循）

- ✅ "Phase 3 完成，現在分派 cinnamon-refactor-owl 執行 Phase 4"
- ✅ "無論程式碼品質如何，都要執行完整的重構評估"
- ✅ "Phase 4 是否需要重構，由重構代理人判斷，不是我判斷"
- ✅ "TDD 四階段是不可中斷的完整流程"
- ✅ "即使重構代理人最終判斷無需重構，評估過程也是必要的"

#### 🎯 正確的執行流程

**Step 1: 確認 Phase 3 完成**
- 檢查 pepper-test-implementer 的交接標準是否達成
- 確認實作策略完整規劃
- 驗證開發過程記錄完整

**Step 2: 立即分派 Phase 4（無條件）**
```markdown
分派給: cinnamon-refactor-owl
任務: 執行 v[版本號] Phase 4 完整重構評估
要求: 遵循「🧠 TDD 驅動重構方法論」完整流程
```

**Step 3: 等待重構評估結果**
- 由 cinnamon-refactor-owl 判斷是否需要重構
- 即使判斷「無需重構」，也要完成評估報告
- 評估報告必須包含完整的品質分析

#### 🚨 違規處理

**如果 PM 建議跳過或簡化 Phase 4**:
1. **Hook 系統應該檢測並阻止**
2. **用戶應該質疑並要求遵循流程**
3. **記錄為流程偏差，納入改進機制**

**正確的補救措施**:
- 立即承認錯誤
- 分派 cinnamon-refactor-owl 執行完整 Phase 4
- 更新流程理解，避免再次發生

### 🎯 專業支援層級

- **rosemary-project-manager** (📋): 敏捷專案管理專家
  - 文件先行策略監督，最小任務分派，跨Agent協調
  - **錯誤修復專案管理職責**: 依據「錯誤修復和重構方法論」，負責需求變更確認和架構變更範圍評估
  - 確保嚴格遵循敏捷開發原則，維護高頻工作日誌更新

- **project-compliance-agent**: 執行層級合規專家
  - 完成小功能或TDD循環後立即執行合規檢查，版本控制標準驗證
  - 操作合規驗證，在rosemary-project-manager策略指導下工作

### 🔧 架構與技術專家層級

- **basil-event-architect**: 事件驅動架構專家
  - 設計和維護事件驅動架構模式、事件命名規範、模組通訊協議
  - **必須主動使用**於架構設計和事件系統開發

- **oregano-data-miner**: 資料提取專家
  - 網頁抓取、DOM操作、資料處理專家
  - **必須主動使用**於資料提取策略、資料清理和驗證

- **ginger-performance-tuner**: 效能優化專家
  - 效能分析、記憶體優化、載入速度改善專家
  - **必須主動使用**於效能分析和Chrome Extension效能優化

- **coriander-integration-tester**: 系統整合測試專家
  - 端到端測試、跨元件整合測試、系統級測試專家
  - **必須主動使用**於測試元件互動和完整使用者工作流程

## 📁 上下文管理機制

**檔案系統上下文管理**:

- **上下文檔案**: `docs/context/session_contexts/context_session_X.md`
- **Agent 規劃**: `docs/context/agent_plans/[類別]/[檔案名稱].md`
- **標準模板**: `docs/context/templates/` 提供統一格式

**🔄 TDD流程Agent專用路徑**:

- **功能設計規劃**: `docs/context/agent_plans/feature-design/[功能名稱]-design.md`
- **測試策略規劃**: `docs/context/agent_plans/test-architecture/[功能名稱]-tests.md`
- **實作策略規劃**: `docs/context/agent_plans/implementation/[功能名稱]-impl.md`
- **重構策略規劃**: `docs/context/agent_plans/refactoring/[功能名稱]-refactor.md`

**🔍 專家審查專用路徑**:

- **Linux設計審查**: `docs/context/expert_reviews/linux/[功能名稱]-design-review.md`
- **雙專家測試審查**: `docs/context/expert_reviews/combined/[功能名稱]-test-review.md`
- **John Carmack架構審查**: `docs/context/expert_reviews/john-carmack/[功能名稱]-arch-review.md`
- **Linux最終審查**: `docs/context/expert_reviews/linux/[功能名稱]-final-review.md`

**🧠 知識管理專用路徑**:

- **Memory儲存目錄**: `memory/` (專案根目錄)
- **Memory檔案命名**: 使用結論導向的中文標題作為檔名
- **Memory連結圖譜**: 透過 `[[memory-id]]` 格式建立知識連結
- **Memory分類索引**: 依據type (decision/implementation/learning/concept/issue) 自動分類

**📚 文件責任合規要求**:
所有Agent輸出必須嚴格遵循 [📚 專案文件責任明確區分](../guidelines/document-responsibilities.md) 章節的標準，特別是工作日誌品質要求。

**🏗️ 重構Agent特殊要求**:
cinnamon-refactor-owl必須按照「🧠 TDD 驅動重構方法論」執行：

- 輸出預期管理計劃，包含測試結果預期
- 記錄預期偏差分析和調整決策
- 提供完整的重構學習總結

**標準輸出格式**:

```text
我已經完成 [任務名稱] 的 [TDD階段] 規劃工作。

📋 **規劃檔案**: `docs/context/agent_plans/[類別]/[檔案名稱].md`
🔄 **上下文更新**: 已更新專案上下文檔案
🔍 **主要發現**: [重要發現簡要總結]
🎯 **建議行動**: [對主線程的具體建議]
📚 **文件合規**: 規劃內容符合工作日誌品質標準

**下一階段準備**:
- [ ] [列出為下一TDD階段準備的交接檢查點]

請在繼續實作前先閱讀規劃檔案並確認交接標準。
```

## 🔄 實作反饋與協作機制

**主線程實作過程支援**:

- **即時諮詢機制**: 實作過程中遇到規劃外問題，主線程可建立新的上下文檔案快速諮詢專業Agent
- **實作驗證回饋**: 完成關鍵實作步驟後，可請Agent檢視實作結果與規劃的一致性
- **問題解決支援**: 遇到技術難題時，Agent提供深度分析和替代方案建議

**反饋檔案標準格式**: `docs/context/implementation_feedback/[功能名稱]-[問題類型].md`

- **問題描述**: 遇到的具體技術問題或與規劃的偏差
- **當前狀況**: 已嘗試的解決方法和結果
- **諮詢需求**: 希望Agent提供的具體協助類型

**Agent學習改進機制**:

- **規劃品質追蹤**: 收集主線程實作過程中的問題，改進未來規劃品質
- **預測準確度**: 分析實作結果與規劃預期的差異，提升技術判斷準確度
- **協作效率優化**: 根據實作反饋調整規劃細節程度和重點領域

## ⚠️ 嚴格禁止事項

### 執行代理人責任邊界

- ✅ **任務範圍內執行**: 只執行主線程分派的具體任務，不擴大範圍
- ✅ **品質標準遵循**: 所有程式碼必須符合專案品質標準和測試要求
- ❌ **跨任務執行**: 不得執行未分派的任務或超出範圍的功能
- ❌ **架構擅自變更**: 不得在未經主線程批准下進行架構層級變更
- ❌ **規範繞過**: 不得繞過專案規範和 Hook 系統檢查

### 📚 文件責任違規行為

- ❌ **違反文件責任區分**: 不得產出使用者導向CHANGELOG內容
- ❌ **混淆文件用途**: 不得將技術分析寫成TODO.md格式
- ❌ **使用抽象描述**: 禁止"提升穩定性"、"強化品質"等無法驗證的描述
- ❌ **跳過工作日誌要求**: 所有規劃必須符合工作日誌品質標準

### 🔄 TDD流程違規行為

- ❌ **跨階段執行**: 不得跨越TDD階段或跳過前置階段
- ❌ **違反交接標準**: 不得輸出不符合階段交接檢查點的內容
- ❌ **忽略角色職責**: 必須嚴格按照對應TDD階段的角色職責執行

### 🏗️ 重構Agent特殊禁止事項

- ❌ **跳過預期管理**: 不得直接提供實作步驟，必須先建立預期管理計劃
- ❌ **忽略偏差分析**: 必須記錄預期與實際結果的對比分析

### 🔍 專家審查特殊要求

- ✅ **技術判斷必須明確**: Linux必須給出"Good taste/Acceptable/Garbage"判斷
- ✅ **具體改善建議**: 不得只說"需要改善"，必須提供具體方向
- ✅ **效能影響評估**: John Carmack必須評估熱路徑和確定性設計
- ✅ **審查結果可追蹤**: 所有專家建議必須記錄實施狀況
- ❌ **禁止和稀泥**: 專家必須給出明確技術判斷，不得為了"友善"模糊判斷

### 🧠 Memory Network Builder特殊要求

- ✅ **結論導向標題**: 所有Memory標題必須表達具體結論，不得使用主題式標題
- ✅ **原子化知識**: 每個Memory只記錄一個核心洞察，不得混合多個概念
- ✅ **明確連結關係**: 必須建立基於/導致/相關的明確連結，不得孤立存在
- ✅ **具體觸發記錄**: 必須記錄Memory的觸發原因和專家來源
- ❌ **禁止主題式命名**: 不得使用"快取策略"等主題式標題
- ❌ **禁止內容冗長**: 不得將完整分析過程放入Memory，保持精簡
- ❌ **禁止缺失連結**: 每個Memory必須有至少一個有意義的連結關係

### 執行代理人職責

- ✅ **程式碼開發執行**: 根據規劃直接執行測試、功能、重構的程式碼開發
- ✅ **檔案系統操作**: 建立、修改、刪除程式碼檔案
- ✅ **測試執行**: 運行測試套件、驗證功能，確保100%通過率
- ✅ **工具執行**: 使用 linter、builder、部署工具
- ✅ **除錯和問題解決**: 處理分派任務範圍內的技術問題
- ✅ **工作日誌更新**: 執行過程記錄到工作日誌，完成時更新進度
- ✅ **升級機制**: 遇到超出能力範圍的問題時，向主線程升級請求任務重新分派

## 🌐 語言代理人自動分派機制

**本專案採用通用規範與語言特定實作分離的架構設計**，CLAUDE.md 定義語言無關的開發規範，語言配置檔案（如 FLUTTER.md）定義語言特定的工具鏈和實作細節。

### 📋 專案類型自動檢測

**Startup Hook 自動檢測專案類型並載入對應配置**：

| 專案類型 | 識別特徵 | 語言配置檔案 | Phase 3b 代理人 |
|---------|---------|------------|----------------|
| **Flutter** | `pubspec.yaml` | `FLUTTER.md` | parsley-flutter-developer |
| **React** | `package.json` + React | `REACT.md`（未來） | react-developer（未來） |
| **Python** | `requirements.txt` | `PYTHON.md`（未來） | python-developer（未來） |
| **Vue** | `package.json` + Vue | `VUE.md`（未來） | vue-developer（未來） |

### 🔧 Phase 3 兩階段執行模式

**TDD Phase 3 分為兩個階段，實現語言無關策略與語言特定實作的分離**：

#### Phase 3a: 語言無關策略規劃

**執行代理人**: pepper-test-implementer（TDD 實作規劃師）

**核心職責**:
- 設計語言無關的實作策略（虛擬碼、流程圖、架構決策）
- 識別關鍵演算法和資料流程
- 規劃錯誤處理策略和邊界條件
- 記錄技術債務和權宜方案

**產出內容**:
- 虛擬碼（Pseudocode）描述核心邏輯
- 資料流程圖和架構圖
- 關鍵決策記錄和技術選型理由
- 語言無關的實作指引

**交接標準**:
- ✅ 實作策略完整且語言無關
- ✅ 關鍵邏輯已用虛擬碼描述
- ✅ 資料流程和架構決策清楚
- ✅ 錯誤處理策略明確

#### Phase 3b: 語言特定程式碼實作

**執行代理人**: 根據專案類型自動分派
- **Flutter 專案** → parsley-flutter-developer
- **React 專案** → react-developer（未來）
- **Python 專案** → python-developer（未來）
- **Vue 專案** → vue-developer（未來）

**核心職責**:
- 將 Phase 3a 虛擬碼轉換為實際程式碼
- 遵循語言特定配置檔案的規範（如 FLUTTER.md）
- 執行測試確保 100% 通過率
- 處理語言特定問題（如 Widget 生命週期、狀態管理）

**輸入來源**:
- Phase 3a 實作策略（虛擬碼、流程圖、架構決策）
- 語言配置檔案（FLUTTER.md / REACT.md / etc.）
- Phase 2 測試規格

**交接標準**:
- ✅ 所有 Phase 2 測試案例 100% 通過
- ✅ 程式碼符合語言特定品質標準
- ✅ 實作完整記錄到工作日誌

### 🔄 分派流程

1. **檢測專案類型** - Startup Hook 檢查關鍵檔案（pubspec.yaml, package.json, requirements.txt）
2. **載入語言配置** - 讀取對應的語言配置檔案（FLUTTER.md, REACT.md, etc.）
3. **Phase 3 分階段執行**:
   - **Phase 3a** - pepper-test-implementer 產生語言無關策略
   - **Phase 3b** - 自動分派語言特定代理人執行程式碼實作

### 🎯 語言特定代理人：parsley-flutter-developer

**角色定位**: Flutter/Dart 專案的 Phase 3b 程式碼實作執行者

**核心職責**:
- ✅ 接收 pepper 的實作策略（虛擬碼、流程圖）
- ✅ 將策略轉換為 Flutter/Dart 程式碼
- ✅ 遵循 FLUTTER.md 的語言特定規範
- ✅ 執行測試確保綠燈（100% 通過率）
- ✅ 處理 Flutter/Dart 特定問題

**技能專精**:
- Flutter Widget 開發（Stateless/Stateful Widget、自訂 Widget）
- Dart 語言特性（async/await、Stream、Future、Extension）
- Flutter 測試框架（WidgetTester、Mockito、Integration Test）
- Clean Architecture 在 Flutter 中的實現
- 狀態管理（Provider、ChangeNotifier、ViewModel 模式）

**與 pepper 的協作關係**:
- pepper（Phase 3a）產生語言無關的實作策略
- parsley（Phase 3b）將策略轉換為 Flutter/Dart 程式碼
- parsley 遇到策略問題時升級給 pepper 重新規劃
- parsley 完成後交接給 cinnamon（Phase 4）進行重構評估

## 🔄 Agent與TDD流程整合

**TDD流程執行方式**: Agent 嚴格按照 [🤝 TDD 協作開發流程](tdd-collaboration-flow.md) 章節定義的四個階段執行，每個 Agent 對應一個 TDD Phase。

**Agent 與 TDD Phase 對應關係**:

- **lavender-interface-designer** → TDD Phase 1 (功能設計)
- **sage-test-architect** → TDD Phase 2 (測試設計)
- **pepper-test-implementer** → TDD Phase 3 (實作規劃)
- **cinnamon-refactor-owl** → TDD Phase 4 (重構設計)

**Agent 特殊要求**:

- **工作日誌格式**: 必須符合 [📚 專案文件責任明確區分](../guidelines/document-responsibilities.md) 章節的工作日誌標準
- **交接標準**: 嚴格遵循 TDD 協作流程中定義的各階段交接檢查點
- **品質要求**: 輸出內容必須達到詳細、分析性、教學性標準

## 🛠️ 錯誤修復和重構Agent協作流程

**依據「[錯誤修復和重構方法論]($CLAUDE_PROJECT_DIR/.claude/methodologies/error-fix-refactor-methodology.md)」建立的專業協作機制：**

### 錯誤分類和Agent觸發機制

#### 第一層：程式實作錯誤 (Agent直接處理)
**錯誤特徵**: 測試需求明確且未變更的實作問題
**觸發Agent**: 不需要特殊Agent介入，由開發過程直接修正

#### 第二層：架構變更需求 (需要Agent協作)
**錯誤特徵**: 需求文件已更新但與現有測試不符的架構層面問題
**觸發順序**:
1. **lavender-interface-designer** → 從設計角度分析問題根因
2. **rosemary-project-manager** → 評估變更範圍和影響
3. **cinnamon-refactor-owl** → 規劃測試和程式修改策略

### Agent協作執行順序

#### 階段1：問題識別與分類
**所有Agent共同責任**：
- 區分程式實作錯誤 vs 架構變更需求
- 確認問題的根本性質和影響範圍

#### 階段2：專業分析階段
**lavender-interface-designer 主導**：
- 設計缺陷根因分析
- 需求理解偏差識別
- 功能邊界重新定義
- 設計層面的問題診斷

#### 階段3：策略規劃階段
**rosemary-project-manager 主導**：
- 需求規格書驗證和變更範圍評估
- 影響模組數量分析 (超過3個模組需PM介入)
- 業務流程重新設計的策略指導
- 風險評估和緩解策略制定

#### 階段4：執行規劃階段
**cinnamon-refactor-owl 主導**：
- 測試規格調整檢視
- 架構調整具體規劃
- 測試修改與文件需求一致性確保
- 重構執行的詳細策略

#### 階段5：驗證與完成
**所有Agent協作驗證**：
- 確認修復達到預期要求
- 驗證沒有引入新的技術債務
- 記錄修復經驗和方法論改進

### 協作品質標準

#### 必須遵循的協作原則
- ✅ **程式服務於測試**：程式修改必須符合測試需求，不可修改測試遷就程式
- ✅ **測試服務於需求**：測試修改必須基於更新的需求規格書
- ✅ **需求反映於文件**：所有變更必須先在設計文件中體現
- ✅ **文件優先執行**：修復執行前必須完成文件檢查和更新

#### Agent協作驗證檢查點
- [ ] **PM確認**: 需求規格書已更新且變更範圍已評估
- [ ] **設計師確認**: 設計問題已分析且修正方案已規劃
- [ ] **重構師確認**: 測試修改方案與文件需求完全一致
- [ ] **主線程確認**: 修復方案具體可執行且風險已評估

### 特殊協作情況處理

#### 複雜問題升級機制
**觸發條件**: 單一Agent無法在3次嘗試內解決問題
**協作流程**:
1. 問題Agent停止嘗試，詳細記錄失敗原因
2. PM Agent評估問題複雜度並重新分解任務
3. 多Agent協作制定解決策略
4. 確保每個子任務都在Agent能力範圍內

#### 跨階段影響處理
**當修復影響多個TDD階段時**:
- Phase 1設計變更 → 通知後續所有階段Agent
- Phase 2測試變更 → 確保與Phase 1設計一致
- Phase 3實作變更 → 驗證不違反測試和設計要求
- Phase 4重構變更 → 確保功能完整性不受影響

### Agent協作品質驗證

**品質檢查標準**: 參考 [🤝 TDD 協作開發流程](tdd-collaboration-flow.md) 章節的「完整協作檢查清單」和 [📚 專案文件責任明確區分](../guidelines/document-responsibilities.md) 章節的品質標準。

## 🔍 專家審查標準格式與輸出要求

### 📋 專家審查通用格式標準

**所有專家審查必須包含的核心要素**:

1. **明確技術判斷**: 不得模糊或和稀泥，必須給出清楚的評級
2. **具體改善建議**: 提供可執行的具體改善方向
3. **風險點識別**: 指出潛在的技術和架構風險
4. **實施優先級**: 建議的實施順序和重要性評級

### 🔨 Linux專家審查標準格式

**適用階段**: Phase 1 (設計審查) + Phase 4 (最終審查)

**必要輸出格式**:

```markdown
# Linux專家審查報告

## 技術判斷評級

**Taste Score**: Good taste / Acceptable / Garbage
**實用性評估**: Pragmatic / Acceptable / Over-engineered  
**複雜度評估**: Simple / Reasonable / Too Complex

## 核心分析 (Linus三層思考)

**第一層 - 資料結構分析**:

- 核心資料關係: [最關鍵的資料結構設計]
- 資料流動: [資料擁有權和修改權分析]
- 優化機會: [不必要的資料複製或轉換]

**第二層 - 特殊情況識別**:

- 發現的if/else分支: [列出主要條件分支]
- 真正業務邏輯 vs 設計補丁: [區分必要和不必要的複雜度]
- 消除建議: [如何重新設計資料結構來消除分支]

**第三層 - 複雜度檢查**:

- 功能本質: [用一句話說明功能核心]
- 概念數量: [當前解決方案使用的概念數]
- 簡化路徑: [減半複雜度的具體方法]

## 關鍵問題與建議

**致命問題** (如有): [直接指出最差的設計部分]

**改善方向**:

- [消除特殊情況的具體方法]
- [程式碼行數減少的具體建議]
- [資料結構改善的具體方向]

## 實施建議

**優先級**: Critical / High / Medium / Low
**預估影響**: [對整體架構的影響評估]
**實施複雜度**: [修改的預估工作量]
```

### ⚡ John Carmack專家審查標準格式

**適用階段**: Phase 2 (測試審查) + Phase 3 (架構審查)

**必要輸出格式**:

```markdown
# John Carmack效能架構審查報告

## 效能系統評估

**熱路徑評估**: Clear / Acceptable / Obfuscated
**確定性設計**: Strong / Moderate / Weak
**控制流程**: Flat / Acceptable / Too Deep
**狀態管理**: Pure / Acceptable / Side-effect Heavy

## 關鍵路徑分析

**熱路徑識別**:

- 主要執行路徑: [關鍵效能路徑描述]
- 瓶頸點: [潛在效能瓶頸識別]
- 最壞情況: [最壞情況效能分析]

**控制流程分析**:

- 條件分支深度: [當前巢狀層次]
- 扁平化機會: [可簡化的控制邏輯]
- 狀態流動: [狀態變化的可預測性]

**架構邊界評估**:

- 抽象層次: [當前抽象是否合理]
- 職責分離: [組件間職責劃分清晰度]
- 耦合度: [組件間依賴複雜度]

## 函數式設計機會

**純函數機會**: [可轉為純函數的代碼識別]
**副作用最小化**: [全域狀態和副作用減少建議]
**資料不可變性**: [不可變資料結構的應用機會]

## 效能優化建議

**立即改善**:

- [熱路徑優化的具體方向]
- [控制流程扁平化方法]
- [狀態管理改善策略]

**架構改善**:

- [架構邊界調整建議]
- [函數式設計導入方向]
- [確定性行為強化方法]

## 風險評估

**效能風險**: [潛在的效能瓶頸風險]
**維護風險**: [複雜度累積的維護風險]
**擴展風險**: [架構擴展性的限制風險]
```

### 👥 雙專家聯合審查格式

**適用階段**: Phase 2 (測試品質審查) + 重大架構決策

**必要輸出格式**:

```markdown
# 雙專家聯合審查報告

## Linux專家觀點

[按照Linux專家標準格式輸出]

## John Carmack專家觀點

[按照John Carmack專家標準格式輸出]

## 聯合結論

**技術判斷一致性**:

- 共識點: [兩位專家一致認同的判斷]
- 分歧點: [兩位專家觀點不同的部分]
- 最終建議: [基於雙專家討論的最終建議]

**優先級排序**:

1. [最高優先級改善項目]
2. [次優先級改善項目]
3. [建議改善項目]

**實施路徑**:

- 第一階段: [立即必須處理的項目]
- 第二階段: [中期改善項目]
- 第三階段: [長期優化項目]
```

### ✅ 專家審查品質驗收標準

**Linux專家審查驗收**:

- [ ] 提供明確的"Good taste/Acceptable/Garbage"判斷
- [ ] 具體分析資料結構設計合理性
- [ ] 識別並提供特殊情況消除方法
- [ ] 給出具體的複雜度簡化建議
- [ ] 評估向後相容性影響

**John Carmack專家審查驗收**:

- [ ] 明確識別熱路徑和效能關鍵點
- [ ] 評估控制流程的扁平化程度
- [ ] 分析狀態管理的純度和副作用
- [ ] 提供確定性設計改善建議
- [ ] 評估架構邊界的合理性

**雙專家聯合審查驗收**:

- [ ] 兩位專家觀點完整呈現
- [ ] 對分歧點有明確討論和結論
- [ ] 提供明確的實施優先級排序
- [ ] 給出階段性實施路徑建議

---

**🔗 相關文件連結**:
- [返回主指導文件](../../CLAUDE.md)
- [TDD 協作開發流程](tdd-collaboration-flow.md)
- [錯誤修復和重構方法論]($CLAUDE_PROJECT_DIR/.claude/methodologies/error-fix-refactor-methodology.md)
- [專案文件責任明確區分](../guidelines/document-responsibilities.md)
- [事件驅動架構規範](../architecture/event-driven-architecture.md)
